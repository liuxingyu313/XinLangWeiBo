//
//  WXScanView.m
//  QRCode
//
//  Created by JayWon on 15/12/10.
//  Copyright ¬© 2015Âπ¥ JayWon. All rights reserved.
//

#import "WXScanView.h"
#import "WXScanResult.h"
#import <AVFoundation/AVFoundation.h>
#import "WXScanGridView.h"
#import "WXShowResultController.h"
#import "WXMyQRCodeController.h"

@implementation UIView (ViewController)
- (UIViewController *)viewController {
    UIResponder *next = self.nextResponder;
    while (next != nil) {
        if ([next isKindOfClass:[UIViewController class]]) {
            return (UIViewController *)next;
        }
        next = next.nextResponder;
    }
    return nil;
}
@end


@interface WXScanView () <UINavigationControllerDelegate, UIImagePickerControllerDelegate, AVCaptureMetadataOutputObjectsDelegate>
@property (nonatomic, strong)AVCaptureDeviceInput *deviceInput;     //Áõ∏Êú∫ËæìÂÖ•Ê∫êÔºàÊâãÁîµÁ≠íÂäüËÉΩ„ÄÅÊâ´ÊèèÁÖßÁâáÔºâ
@property (nonatomic, strong)AVCaptureMetadataOutput *deviceOuput;  //Êï∞ÊçÆËæìÂá∫Ê∫êÔºàÊâ´ÊèèÁªìÊûúÔºâ
@property (nonatomic, strong)AVCaptureSession *session;             //‰ºöËØùÊÄªÁÆ°ÔºåÁÆ°ÁêÜËæìÂÖ•(AVCaptureInput)ÂíåËæìÂá∫(AVCaptureOutput)ÊµÅ
@property (nonatomic, weak)AVCaptureVideoPreviewLayer *avLayer;     //ÊòæÁ§∫‰ºöËØùÔºàsessionÔºâ
@property (nonatomic, weak)WXScanGridView *gridView;                //Êâ´ÊèèÈÄèÊòéÂ±Ç
@property (nonatomic, weak)UIButton *flashBtn;                      //ÊâãÁîµÁ≠íÂºÄÂÖ≥
@end

@implementation WXScanView

- (instancetype)init
{
    return [self initWithFrame:[UIScreen mainScreen].bounds];
}

- (instancetype)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        [self _initUI];
    }
    return self;
}

- (void)awakeFromNib {
    [self _initUI];
}

#pragma mark - AVCaptureDeviceInput
- (AVCaptureDeviceInput *)deviceInput {
    if (!_deviceInput) {
        //Áõ∏Êú∫Á°¨‰ª∂ÁöÑÊé•Âè£ÔºåÁî®‰∫éÊéßÂà∂Á°¨‰ª∂ÁâπÊÄßÔºöÈïúÂ§¥ÁöÑ‰ΩçÁΩÆ„ÄÅÊõùÂÖâ„ÄÅÈó™ÂÖâÁÅØÁ≠â
        AVCaptureDevice *device = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];
        if (!device) {
            NSLog(@"Êó†ÂèØÁî®Áõ∏Êú∫");
            return nil;
        }
        //Ëá™Âä®ÂØπÁÑ¶ËÆæÁΩÆ
        if (device.isFocusPointOfInterestSupported && [device isFocusModeSupported:AVCaptureFocusModeAutoFocus]) {
            [device lockForConfiguration:nil];
            [device setFocusMode:AVCaptureFocusModeContinuousAutoFocus];
            [device unlockForConfiguration];
        }
        _deviceInput = [AVCaptureDeviceInput deviceInputWithDevice:device error:nil];
        if (!_deviceInput) {
            NSLog(@"ÊÇ®Â∑≤ÂÖ≥Èó≠Áõ∏Êú∫‰ΩøÁî®ÊùÉÈôêÔºåËØ∑Ëá≥ÊâãÊú∫ ËÆæÁΩÆ->ÈöêÁßÅ->Áõ∏Êú∫ ‰∏≠ÊâìÂºÄ");
            return nil;
        }
    }
    return _deviceInput;
}

#pragma mark - ÂêØÂä®
- (void)startScan {
    
    [_gridView startAnimation];
    
    if (!_session.isRunning) {
        [_session startRunning];
    }
}

- (void)stopScan {
    
    [_gridView stopAnimation];
    
    //ÂÖ≥Èó≠ÊâãÁîµÁ≠í
    if(_deviceInput.device.torchMode == AVCaptureTorchModeOn) {
        [self _openOrCloseFlash];
    }
    
    //ÂÖ≥Èó≠‰ºöËØù
    if (_session.isRunning)
        [_session stopRunning];
}

#pragma mark -
- (void)_initUI {
    
    //Â±ÇÁ∫ßÂÖ≥Á≥ªÁî±‰∏ãËá≥‰∏ä‰æùÊ¨°‰∏∫ÔºöÁõ∏Êú∫ - ÂçäÈÄèÊòéÂ±Ç - Ëß¶Êë∏Âå∫ÊàñÊèêÁ§∫Âå∫
    
    [self _initAVComponents];   //1.Áõ∏Êú∫Â±Ç
    [self _initScanView];       //2.ÂçäÈÄèÊòéÂ±Ç
    [self _initTipLabel];       //3.ÊèêÁ§∫ËØ≠
    [self _initBottomBar];      //4.ÂäüËÉΩÊåâÈíÆ
}

- (void)_initAVComponents {
    if (!self.deviceInput) return;
    
    //1.ÂàõÂª∫ËæìÂá∫ÊµÅ
    AVCaptureMetadataOutput *deviceOuput = [[AVCaptureMetadataOutput alloc] init];
    self.deviceOuput = deviceOuput;
    //ËÆæÁΩÆ‰ª£ÁêÜ Âú®‰∏ªÁ∫øÁ®ãÈáåÂà∑Êñ∞
    [_deviceOuput setMetadataObjectsDelegate:self queue:dispatch_get_main_queue()];
    //ËÆæÁΩÆÊâ´ÊèèÂå∫ÂüüÔºàÂèñÂÄºÊòØ‰∏Ä‰∏™ÊØîÁéáÂÄºÔºâÔºåÈªòËÆ§ÂÖ®Â±èÂπïÊâ´Êèè
    //_deviceOuput.rectOfInterest = CGRectMake(0, 0, 1, 1);

    //2.ÂàõÂª∫Áõ∏Êú∫
    AVCaptureSession *session = [[AVCaptureSession alloc] init];
    self.session = session;
    //È¢ÑÁΩÆÁîªÈù¢ÈááÈõÜË¥®ÈáèÔºàÈ´òË¥®ÈáèÈü≥È¢ëËßÜÈ¢ëËæìÂá∫Ôºâ
    if ([_session canSetSessionPreset:AVCaptureSessionPresetHigh]) {
        [_session setSessionPreset:AVCaptureSessionPresetHigh];
    }
    if ([_session canAddInput:self.deviceInput]) {
        [_session addInput:self.deviceInput];
    }
    if ([_session canAddOutput:_deviceOuput]) {
        [_session addOutput:_deviceOuput];
    }
    
    //3.ËÆæÁΩÆÊîØÊåÅÁöÑÊâ´Á†ÅÊ†ºÂºèÔºàÂùëÔºöÈúÄË¶Å_deviceOuputË¢´Ê∑ªÂä†Âà∞AVCaptureSessionÂêéÔºåÊâçËÉΩËÆæÁΩÆmetadataObjectTypesÔºâ
    //ÊâãÂä®ËÆæÁΩÆÊ†ºÂºè
    //_deviceOuput.metadataObjectTypes = [self defaultMetaDataObjectTypes];
    //Á≥ªÁªüÂà§Êñ≠ÂèØÁî®ÁöÑÊ†ºÂºè
    _deviceOuput.metadataObjectTypes = [_deviceOuput availableMetadataObjectTypes];
    
    //4.Áõ∏Êú∫ÊòæÁ§∫
    AVCaptureVideoPreviewLayer *layer = [AVCaptureVideoPreviewLayer layerWithSession:_session];
    layer.videoGravity = AVLayerVideoGravityResizeAspectFill;
    layer.frame = self.layer.bounds;
    [self.layer insertSublayer:layer atIndex:0];
    self.avLayer = layer;
}

//ÂçäÈÄèÊòéÂ±Ç
- (void)_initScanView {
    WXScanGridView *gridView = [[WXScanGridView alloc] initWithFrame:self.bounds];
    [self addSubview:gridView];
    self.gridView = gridView;
}

- (void)_initTipLabel {
    UILabel *topTitle = [[UILabel alloc] init];
    topTitle.font = [UIFont systemFontOfSize:15];
    topTitle.textAlignment = NSTextAlignmentCenter;
    topTitle.numberOfLines = 0;
    topTitle.text = @"‰∏áËÉΩÊâ´Á†Å - üì∑ÂØπÂáÜÊâ´ÊèèÊ°Ü";
    topTitle.textColor = [UIColor whiteColor];
    [topTitle sizeToFit];
    topTitle.center = CGPointMake(CGRectGetWidth(self.frame)/2, CGRectGetHeight(self.frame)*0.22);
    [self addSubview:topTitle];
}

//Áõ∏ÂÜå„ÄÅÂºÄÁÅØ„ÄÅÊàëÁöÑ‰∫åÁª¥Á†Å
- (void)_initBottomBar {
    CGFloat barHeight = 100.0;
    UIView *bottomView = [[UIView alloc] initWithFrame:CGRectMake(0, CGRectGetMaxY(self.frame)-barHeight, CGRectGetWidth(self.frame), barHeight)];
    bottomView.backgroundColor = [UIColor colorWithRed:0 green:0 blue:0 alpha:0.6];
    [self addSubview:bottomView];

    CGFloat btnWidth = 65;
    CGFloat btnHeight = 87;
    CGFloat btnSpace = (CGRectGetWidth(bottomView.frame)- btnWidth*3) / 4;
    
    UIButton *photoBtn = [[UIButton alloc] initWithFrame:CGRectMake(btnSpace, (barHeight-btnHeight)/2, btnWidth, btnHeight)];
    [photoBtn setImage:[UIImage imageNamed:@"CodeScan.bundle/qrcode_scan_btn_photo_nor"] forState:UIControlStateNormal];
    [photoBtn setImage:[UIImage imageNamed:@"CodeScan.bundle/qrcode_scan_btn_photo_down"] forState:UIControlStateHighlighted];
    [photoBtn addTarget:self action:@selector(_openPhoto) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *flashBtn = [[UIButton alloc] initWithFrame:CGRectMake(CGRectGetMaxX(photoBtn.frame)+btnSpace, (barHeight-btnHeight)/2, btnWidth, btnHeight)];
    [flashBtn setImage:[UIImage imageNamed:@"CodeScan.bundle/qrcode_scan_btn_flash_nor"] forState:UIControlStateNormal];
    [flashBtn addTarget:self action:@selector(_openOrCloseFlash) forControlEvents:UIControlEventTouchUpInside];
    
    UIButton *myQRBtn = [[UIButton alloc] initWithFrame:CGRectMake(CGRectGetMaxX(flashBtn.frame)+btnSpace, (barHeight-btnHeight)/2, btnWidth, btnHeight)];
    [myQRBtn setImage:[UIImage imageNamed:@"CodeScan.bundle/qrcode_scan_btn_myqrcode_nor"] forState:UIControlStateNormal];
    [myQRBtn setImage:[UIImage imageNamed:@"CodeScan.bundle/qrcode_scan_btn_myqrcode_down"] forState:UIControlStateHighlighted];
    [myQRBtn addTarget:self action:@selector(_myQRCode) forControlEvents:UIControlEventTouchUpInside];
    
    [bottomView addSubview:flashBtn];
    [bottomView addSubview:photoBtn];
    [bottomView addSubview:myQRBtn];
    
    self.flashBtn = flashBtn;
}

- (NSArray *)defaultMetaDataObjectTypes {
    NSMutableArray *types = [@[AVMetadataObjectTypeQRCode,
                               AVMetadataObjectTypeUPCECode,
                               AVMetadataObjectTypeCode39Code,
                               AVMetadataObjectTypeCode39Mod43Code,
                               AVMetadataObjectTypeEAN13Code,
                               AVMetadataObjectTypeEAN8Code,
                               AVMetadataObjectTypeCode93Code,
                               AVMetadataObjectTypeCode128Code,
                               AVMetadataObjectTypePDF417Code,
                               AVMetadataObjectTypeAztecCode] mutableCopy];
    
    if ([[UIDevice currentDevice].systemVersion floatValue] >= 8.0) {
        [types addObjectsFromArray:@[
                                     AVMetadataObjectTypeInterleaved2of5Code,
                                     AVMetadataObjectTypeITF14Code,
                                     AVMetadataObjectTypeDataMatrixCode
                                     ]];
    }
    return types;
}

#pragma mark - Â∫ïÈÉ®ÂäüËÉΩ
//ÊâìÂºÄÁõ∏ÂÜå‰∫åÁª¥Á†Å
- (void)_openPhoto{
    UIImagePickerController *picker = [[UIImagePickerController alloc] init];
    picker.sourceType = UIImagePickerControllerSourceTypePhotoLibrary;
    picker.delegate = self;
    picker.allowsEditing = YES;
    [self.viewController presentViewController:picker animated:YES completion:nil];
}

//ÊâãÁîµÁ≠í
- (void)_openOrCloseFlash{
    if (!self.deviceInput) return;
    
    [self.deviceInput.device lockForConfiguration:nil];
    _deviceInput.device.torchMode = (_deviceInput.device.torchMode == AVCaptureTorchModeOn) ? AVCaptureTorchModeOff : AVCaptureTorchModeOn;
    [_deviceInput.device unlockForConfiguration];
    
    (_deviceInput.device.torchMode == AVCaptureTorchModeOn) ? [_flashBtn setImage:[UIImage imageNamed:@"CodeScan.bundle/qrcode_scan_btn_flash_down"] forState:UIControlStateNormal] : [_flashBtn setImage:[UIImage imageNamed:@"CodeScan.bundle/qrcode_scan_btn_flash_nor"] forState:UIControlStateNormal];
}

//ÁîüÊàêËá™Â∑±ÁöÑ‰∫åÁª¥Á†Å
- (void)_myQRCode{
    WXMyQRCodeController *myQRCodeCtrl = [[WXMyQRCodeController alloc] init];
    [self.viewController.navigationController pushViewController:myQRCodeCtrl animated:YES];
}

#pragma mark -
- (void)imagePickerController:(UIImagePickerController*)picker didFinishPickingMediaWithInfo:(NSDictionary *)info {
    UIImage* image = [info objectForKey:UIImagePickerControllerEditedImage];
    if (!image){
        image = [info objectForKey:UIImagePickerControllerOriginalImage];
    }
    [picker dismissViewControllerAnimated:YES completion:nil];

    //ËØÜÂà´ÂõæÁâá‰∫åÁª¥Á†Å„ÄÇiOS8‰πãÂêéÂèØ‰ΩøÁî®Á≥ªÁªüÊé•Âè£Ôºå‰ΩÜÊ≠§apiÊúâÈóÆÈ¢òÔºåÂú®iPhone 4s„ÄÅ5„ÄÅ5s(iOS<9) ‰∏ädetector‰∏∫nil
    if ([[UIDevice currentDevice].systemVersion floatValue] >= 8.0) {
        CIContext *context = [CIContext contextWithOptions:nil];
        CIDetector *detector = [CIDetector detectorOfType:CIDetectorTypeQRCode context:context options:@{CIDetectorAccuracy : CIDetectorAccuracyHigh}];
        if (detector) {
        NSArray *features = [detector featuresInImage:[CIImage imageWithCGImage:image.CGImage]];
        if (features.count == 0) {
            NSLog(@"ÂõæÁâá‰∏≠Êó†‰∫åÁª¥Á†Å");
            return;
        }
        
        CIQRCodeFeature *feature = [features firstObject];
        WXScanResult *result = [[WXScanResult alloc] init];
        result.strScanned = feature.messageString;
        result.strBarCodeType = feature.type;
        result.imgScanned = image;
        WXShowResultController *resultCtrl = [[WXShowResultController alloc] initWithResult:result];
        [self.viewController.navigationController pushViewController:resultCtrl animated:YES];
        }
    } else {
        //TODO:iOS7‰πãÂâç‰ΩøÁî®ZBarËØÜÂà´
        /*
         ZBar Âú®Êâ´ÊèèÁÅµÊïèÂ∫¶ÂíåÂÜÖÂ≠ò‰ΩøÁî®‰∏äÊØîZXing‰ºòÁßÄÔºå‰ΩÜÊòØ02Âπ¥‰πãÂêéÂ∞±ÂÅúÊ≠¢Êõ¥Êñ∞Ôºå‰∏çÊîØÊåÅ64‰ΩçÂ§ÑÁêÜÂô®ÔºàÂà∞ÁõÆÂâç‰ΩçÁΩÆËøòËÉΩÁî®Ôºâ
         ZXing Âú®ÁÅµÊïèÂ∫¶„ÄÅËØÜÂà´Áéá„ÄÅËØÜÂà´ÊïàÁéáÊñπÈù¢‰∏çÂ¶ÇZBarÔºå‰ΩÜÊòØ‰∏ÄÁõ¥Êúâ‰∫∫Âú®Áª¥Êä§
         */
    }
}

- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
    [picker dismissViewControllerAnimated:YES completion:nil];
}

#pragma mark - AVCaptureOutputDelegate Ëé∑ÂèñÊâ´ÊèèÁªìÊûú
- (void)captureOutput:(AVCaptureOutput *)captureOutput didOutputMetadataObjects:(NSArray *)metadataObjects fromConnection:(AVCaptureConnection *)connection {
    
    if (metadataObjects.count == 0) {
        return;
    }
    
    AVMetadataObject *metadataObj = [metadataObjects firstObject];
    if ([metadataObj isKindOfClass:[AVMetadataMachineReadableCodeObject class]]) {
        
        [self stopScan];
        
        //1012-iphone  1152-ipad  1109-ipad
        AudioServicesPlaySystemSound(kSystemSoundID_Vibrate);   //ÊåØÂä®ÊèêÈÜí
        AudioServicesPlaySystemSound(1109);                     //Â£∞Èü≥ÊèêÈÜí
        
        WXScanResult *result = [[WXScanResult alloc] init];
        result.strScanned = [(AVMetadataMachineReadableCodeObject *)metadataObj stringValue];
        result.strBarCodeType = metadataObj.type;
        WXShowResultController *resultCtrl = [[WXShowResultController alloc] initWithResult:result];
        [self.viewController.navigationController pushViewController:resultCtrl animated:YES];
    }
}

@end
